## Invoked for both managed entities and for items with $entity and $item both set

## Bind $uri to the path for $item so the general action-tab machinery (in footer.vm) works uniformly
#set($uri = $item.uRI.replaceAll("^https?://[^/]*/",""))

 <div class="row space-above">
  <div class="span12">
    #parse("breadcrumbs.vm")
  </div>
 </div>

 <div class="row">
  <div class="span8">

    <h1>Entity: $entity.name #if($versionNumber)- showing version $versionNumber#end</h1>

    <div class="row">
      <div class="span6">
        <p><strong>URI:</strong>  <a href="#linkhref($entity)" title="$entity.uRI">$entity.uRI</a> </p>
        <p><strong>Type:</strong> #foreach($ty in $entity.listPropertyValues("rdf:type"))#linkfor($ty)#if( $foreach.hasNext ), #end#end </p>
        #description($entity, "<p><em>no description supplied</em></p>")
      </div>
      #if($item.getPropertyValue("reg:status"))
          <div class="span2">
            #showstatus($item.getPropertyValue("reg:status"))
          </div>
      #end
    </div>

    #set($isAdministrator=$lib.reg.isPermitted("Grant", $uri))

    <ul class="nav nav-tabs nav-compact action-tab">
      <li class="active"><a href="#properties" data-toggle="tab">Properties</a></li>
      <li><a href="#metadata" data-toggle="tab">Metadata</a></li>
      <li><a href="#history" data-toggle="tab">History</a></li>
      #if($isAdministrator)
        <li><a href="#administer" data-toggle="tab">Administer</a></li>
      #end
    </ul>

    <div class="tab-content">
      <div class="tab-pane active" id="properties">
        #restable($entity, "table-striped table-condensed table-bordered")
      </div>

      <div class="tab-pane" id="metadata">
         #restable($item, "table-striped table-condensed")
      </div>

      <div class="tab-pane" id="history" data-action="showhistory" data-uri="$uri">
        <p>Loading ...</p>
      </div>

      #if($isAdministrator)
        <div class="tab-pane" id="administer" data-action="embedded-admin" data-args="grant=Maintainer" data-uri="$uri">
          <p>Page is loading ...</p>
        </div>
      #end
    </div>

  </div>

  <div class="span4">
    #parse("formats.vm")

     <div class="panel">
       <div class="panel-head">
         <h4>About the Item</h4>
       </div>
       <div class="panel-body">
         <table class="table table-striped table-condensed">
           #metadatarow("category", $item.listPropertyValues("reg:category"))
           #metadatarow("accepted  on", $item.listPropertyValues("dct:dateAccepted"))
           #metadatarow("submitted on", $item.listPropertyValues("dct:dateSubmitted"))
           #metadatasubmitter($item)
         </table>
       </div>
     </div>


    <div>
      #set($foundAction=false)

      #if($lib.reg.isPermitted("Update", $uri))
        #if(!$foundAction)
          <h3 class="text-center">Actions</h3>
          #set($foundAction=true)
        #end
        <a role="button" class="btn btn-primary" data-toggle="modal" data-target="#update-entity" >Edit <i class="icon-edit icon-white"></i></a>
        #set($editTarget=$entity) #set($id="update-entity")  #parse("edit-form.vm")

        ## Disabled because update breaks the description reference.
        ## <a role="button" class="btn btn-danger" data-toggle="modal" data-target="#update-item" >Edit metadata <i class="icon-edit icon-white"></i></a>
        ## #set($editTarget=$item) #set($id="update-item")  #parse("edit-form.vm")
      #end

      #if($lib.reg.isPermitted("StatusUpdate", $uri))
        #if(!$foundAction)
          <h3 class="text-center">Actions</h3>
          #set($foundAction=true)
        #end
        <a href="#status-dialog" role="button" class="btn btn-primary" data-toggle="modal">Set status</a>

        #statusSet("status-dialog", "Set status of $entity.name to ...", $item, $item)
      #end
    </div>

  </div>
</div>


   <script type="text/javascript">
    $(function() {

       $(".set-status").click(function(event) {
         var action = $(event.target).attr('data-target') + "?update&status=" + $(event.target).attr('data-status');
         $.ajax(action,{
            type : "POST",
            complete :
              function(data, status, xhr){
                $("#status-dialog").modal("hide");
                location.reload();
              },
            error :
              function(xhr, status, error){
               $("#status-error").html("<div class='alert'> <button type='button' class='close' data-dismiss='alert'>&times;</button>Action failed: " + error + " - " + status + "</div>");
              }
         });
       });

    });

   </script>
